[
  {
    "content": "\nYou are an expert data analyst and data engineer who specializes in architecting data pipelines using dbt (data build tool). \n\nYou will be asked to provide your expertise to answer questions about a dbt project. For your task, you will be provided with dbt project context that includes:\n1. The data lineage\n2. Table schema and profiling info\n3. The current file's contents\n\nRules:\n- You will only respond in markdown, using headers, paragraph, bulleted lists and sql/dbt code blocks if needed for the best answer quality possible\n- IMPORTANT: Make sure to inspect the types and typical data in each column when writing sql code.\n- IMPORTANT: make sure all generate sql, dbt jinja examples or included code blocks are syntactically correct and will run in the sql dialect provided when writing any sql code.\n",
    "role": "system"
  },
  {
    "role": "user",
    "content": "\n# Dialect\nUse the bigquery dialect when writing any sql code.\n\n\n# Model lineage\nIMPORTANT: keep in mind how these are connected to each other. You may need to add or modify this structure to complete a task.\n```\n\u251c\u2500\u2500 order_items\n\u2502   \u251c\u2500\u2500 customers\n\u2502   \u2514\u2500\u2500 orders\n\u2502       \u2514\u2500\u2500 customers\n\u2514\u2500\u2500 stg_customers\n    \u2514\u2500\u2500 customers\n```\n\n\n## stg_customers\nCustomer data with basic cleaning and transformation applied, one row per customer.\n\n## Schema and profiling info\nposition,name,type,nullable,nulls,non_nulls,null_frac,n_distinct,duplicates,distinct_frac,avg,max,min,top_values,top_value_counts\n0,customer_id,string,True,0,939,0.0,939,0,1.0,,fee841f2-7082-4658-8935-d8600b309146,00478f33-7c2c-410f-bd43-d79f821cd194,\"['56add541-dabb-4a72-94ed-7f95f35950c1', 'de089162-e488-408c-a07c-07d63c222660', '44a043bd-b9ca-4ee2-b02b-0677c9416ebe', '22205c3f-7a0b-4087-bd98-7d416f6fb5a4', '4040c575-cd0e-44a0-9b2d-533023f59c31', 'fbd824ea-81d2-42e8-a862-af8e38ee0934', 'd4f7af33-91a7-48c4-b10c-e7a4e2ea34b3', '75b742bf-ca6b-41b4-bf31-9692ecfc8353', '54136217-dbf1-4167-bb4a-04fe3cc560ce', 'afd5236e-9e7b-4117-b29f-464de0b73e52', '6cb4ab87-cafe-4045-a147-870d17e24466', '7db5dfa7-a22a-4256-a935-6d66bc0bc58b', 'f2e0f9b8-e254-44d1-b1a7-154cbb79be68', '7d1547f3-ac11-4db6-b8eb-fc125db8ef60', '30169b50-82a4-4785-bafd-3ea0a7813812', '5ea64db5-1713-45a4-809c-599ef53f6ea2', 'd7b899cd-b58c-4a30-b17c-01c08a3df974', 'ca15efb7-c4fa-42f4-8445-ab1d8c7193cd', '229cb9b2-edaf-4310-b9be-d71cce8a2804', 'ea8cee48-2e8a-426c-95e4-92887cab0d9a', 'a72bc755-9f4f-480d-a4d5-3d04c4666ca5', '67f6d9e3-c81d-47d8-90fe-ff870ab37adc', '1e30ede2-af69-4720-aaca-e838ac3ce273', 'f46d3a50-f4b8-4503-815d-d746936208ea', '3acd3d8a-2127-4652-b5c8-8a77fe3ad9b6', '777436aa-4133-418f-ad30-4a8c7c0ffc98', 'cee18dc1-7d99-42ff-a145-16ed3f8cca01', '8465b53e-f273-4605-88a5-94e778ec6b1b', '9c1547b6-05dc-4534-a60f-c75d32b243f3', 'ce814e1e-d843-4a7c-9e00-c755a09284a1']\",\"[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\"\n1,customer_name,string,True,0,939,0.0,926,13,0.986,,Wyatt Hickman,Aaron Gardner,\"['Stephanie Williams', 'Sarah Smith', 'Richard Jones', 'Natalie Hatfield', 'Nicholas Gray', 'Steven Williams', 'John Lowe', 'Ashley Santiago', 'Michael Steele', 'Nicole Jackson', 'Michelle Herring', 'Holly Lee', 'Marc West', 'Don Duran', 'Mary Ruiz', 'Ryan Byrd', 'Aimee Dean', 'Ian Tapia', 'Troy Lane', 'Sean Koch', 'Ryan Rose', 'Ryan Nash', 'Gary Horn', 'Kim Moore', 'Erin King', 'Ryan Hart', 'Gina Kim', 'Ann Yoder', 'Gary Kirk', 'Jay Haley']\",\"[3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\"\n\n\n## Contents\n```sql\nwith\n\nsource as (\n\n    select * from {{ source('ecom', 'raw_customers') }}\n\n),\n\nrenamed as (\n\n    select\n\n        ----------  ids\n        id as customer_id,\n\n        ---------- text\n        name as customer_name\n\n    from source\n\n)\n\nselect * from renamed\n\n```\n\n\n## orders\nOrder overview data mart, offering key details for each order inlcluding if it's a customer's first order and a food vs. drink item breakdown. One row per order.\n\n## Schema and profiling info\nposition,name,type,nullable,nulls,non_nulls,null_frac,n_distinct,duplicates,distinct_frac,avg,max,min,top_values,top_value_counts\n0,order_id,string,True,0,59652,0.0,59652,0,1.0,,fffe9fd6-17de-4a3a-a1a7-3a437c1c6a03,000165b9-8897-4779-86b3-bdc3f727ab9a,\"['b177433e-396f-4da8-b10a-9ed70af6baa2', '7529c4eb-e2da-468d-90eb-948e1d4fa14b', '111df78c-9de7-4b64-8fe5-cf5bee8e3761', '041f086a-6598-45c6-b3d1-0687d55ceab4', 'e00ad36d-1431-4af3-9eb3-0b5468248dbe', 'fa70d4e3-93f8-46a9-be08-01fa98f4c0e7', 'c3454633-abb6-43b2-92d0-c2f90cedb71a', 'e6c97abd-6a9f-4355-8784-de76f0470d00', '90798022-da7b-4e90-89db-5596ddc0a181', '6d17c216-dd35-458a-b1e4-567f609640c7', '52584d89-64d6-4f2c-b22e-906bf4146e79', '7f66bc57-d7b6-4cf4-a425-7ad6947ec467', '9d721c25-9ffb-4f64-9446-b8350f870034', 'e5a63906-c531-4a53-a27a-4fae45b60d90', '53a28db5-8357-4a74-a328-7ffb5a627b86', 'f4c38715-12cb-478e-a2bb-9258a7288382', 'b07a2c33-eadd-40b1-a2de-410fbb7f7353', '59dac0e2-631a-4ead-8c43-8f4d4e46073e', '8c1d4620-0eb4-4b5f-a5a2-a97bef14ca5c', '301d13b8-d284-47fc-b41d-20c8f9782765', 'ff097354-06cb-4b8b-90f1-5058737fe8c9', '4fc7c6f8-5cc1-4ef4-8caa-7f553f274810', '0c0628fb-7e37-4cda-b7ad-1bedb47a8f75', 'c1ef7002-bb03-4389-a195-cc6401b3eded', 'b68923cb-4505-45c7-9430-a5c35a7d9cae', 'b8582a3d-359b-441a-8478-3677f76b6975', '3f47b1f9-b3c1-45fd-bf6f-a20313031c78', '079919fc-b7ac-48fb-8331-acac3dea57a4', 'ae3510de-7931-4ddb-8244-6101e03a121e', 'd6f3fb09-4ee9-41a5-9292-02cd3802cd5b']\",\"[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\"\n1,location_id,string,True,0,59652,0.0,2,59650,0.0,,7f790ed7-0fc4-4de2-a1b0-cce72e657fc4,08d44615-06d3-4086-a5d7-21395a1d975e,\"['7f790ed7-0fc4-4de2-a1b0-cce72e657fc4', '08d44615-06d3-4086-a5d7-21395a1d975e']\",\"[38187, 21465]\"\n2,customer_id,string,True,0,59652,0.0,939,58713,0.016,,fee841f2-7082-4658-8935-d8600b309146,00478f33-7c2c-410f-bd43-d79f821cd194,\"['eb8a5b36-47a8-47ca-9c1b-6417cf79f4b2', '545b7872-c4e0-4687-8b2f-1d13c03ca2ab', 'ee77f7ea-85a5-4ebc-8211-362592fb73d9', '9f0be1ee-2d27-495e-b63e-6ef23b4f8f40', 'dd7021b7-00fa-43cb-a061-6f601d08380d', 'a40cca2b-cb31-42ad-8158-39b67128d0e4', 'd1747387-f31d-48d2-822b-699d6eb93a2b', '7c76af9c-d5fd-460e-82d9-5a7b2a4a118b', 'dbafe507-fda2-48b3-ac00-a14c080210a2', 'dd3b89f6-3929-46fc-91cb-d62cee594688', 'db0d9043-952a-495e-8608-815fdef24bb9', 'c074e00d-755a-4ee3-9efb-9d6786b9517e', '906c6b58-de58-429c-a0d3-93e8d1f52ed7', '29a9dfd0-5ff8-4fdb-a3d5-d7a3928e5f00', 'dacf3f99-3805-4ac8-8ca0-aea33a8990cc', '14cf5ae6-46f6-4727-8b31-099c771e67e7', '7db5dfa7-a22a-4256-a935-6d66bc0bc58b', 'e3afd136-901c-4557-ad38-9721b1da3d6d', 'c9c36c88-ddcd-455e-9513-346a0ef806ce', '8b7f9b7f-90b6-4887-88f8-0e198a9b007d', 'b9b25607-9aa6-407b-a217-ca3a6ac85ee0', 'b57e8de6-9ffe-4318-8d96-ed66f6f29452', 'fd560bc8-60b7-4dbf-93e1-6eba6934f599', '3dd5e6a2-b23b-4ee5-b866-34d2e0a1cd88', 'b028022d-60ff-416a-9106-f3e73dac72d2', 'ca15efb7-c4fa-42f4-8445-ab1d8c7193cd', 'ac22e00c-bce7-4bcb-b15c-bd247a90d81f', 'c93c6590-67d9-4158-aa3c-56b31e7fa654', '8715bdb5-b31c-48eb-b7d9-b5dcd38a1de6', '850a8d12-72ae-40a5-a31b-f36a4477b4b0']\",\"[237, 234, 230, 229, 223, 222, 221, 221, 221, 218, 217, 217, 215, 212, 212, 212, 212, 210, 209, 209, 208, 207, 204, 201, 201, 200, 200, 197, 195, 193]\"\n3,order_total,float64,True,0,59652,0.0,173,59479,0.003,12.5,99.84,0,\"['6.36', '6.24', '5.3', '4.24', '7.42', '7.28', '5.2', '4.16', '19.07', '18.02', '0', '16.96', '11.66', '12.72', '20.14', '18.72', '17.68', '21.2', '15.9', '24.38', '12.48', '22.26', '10.6', '11.44', '16.64', '25.44', '13.78', '23.32', '19.76', '23.92']\",\"[9244, 5641, 4668, 4570, 4454, 2707, 2688, 2681, 1734, 1511, 1119, 967, 798, 771, 755, 679, 598, 577, 522, 518, 497, 429, 413, 413, 404, 376, 331, 326, 309, 304]\"\n4,tax_paid,float64,True,0,59652,0.0,150,59502,0.003,0.63,5.64,0,\"['0.24', '0.36', '0.3', '0.42', '0.28', '0.2', '0.16', '1.08', '1.02', '0.72', '0.96', '0', '0.65', '1.13', '1.2', '0.6', '0.48', '0.68', '0.89', '1.38', '1.44', '1.26', '0.84', '0.44', '0.64', '0.78', '1.31', '1.56', '0.76', '0.92']\",\"[10211, 9341, 4668, 4454, 2707, 2688, 2681, 1817, 1511, 1450, 1192, 1119, 798, 755, 689, 650, 603, 598, 522, 518, 475, 429, 422, 413, 404, 331, 326, 314, 309, 304]\"\n5,ordered_at,timestamp('UTC'),True,0,59652,0.0,365,59287,0.006,,2017-08-31 00:00:00+00,2016-09-01 00:00:00+00,\"['2017-08-28 00:00:00+00', '2017-06-15 00:00:00+00', '2017-08-30 00:00:00+00', '2017-08-24 00:00:00+00', '2017-06-08 00:00:00+00', '2017-08-25 00:00:00+00', '2017-06-12 00:00:00+00', '2017-08-29 00:00:00+00', '2017-08-14 00:00:00+00', '2017-08-22 00:00:00+00', '2017-06-06 00:00:00+00', '2017-06-14 00:00:00+00', '2017-06-19 00:00:00+00', '2017-08-31 00:00:00+00', '2017-05-26 00:00:00+00', '2017-06-09 00:00:00+00', '2017-08-15 00:00:00+00', '2017-06-07 00:00:00+00', '2017-06-05 00:00:00+00', '2017-08-23 00:00:00+00', '2017-08-08 00:00:00+00', '2017-08-16 00:00:00+00', '2017-08-10 00:00:00+00', '2017-05-31 00:00:00+00', '2017-06-16 00:00:00+00', '2017-08-17 00:00:00+00', '2017-05-30 00:00:00+00', '2017-08-09 00:00:00+00', '2017-07-26 00:00:00+00', '2017-06-20 00:00:00+00']\",\"[379, 373, 373, 370, 370, 369, 366, 364, 364, 359, 358, 357, 357, 354, 353, 352, 352, 351, 349, 347, 345, 345, 344, 343, 343, 343, 343, 342, 340, 339]\"\n6,is_food_order,boolean,True,1119,58533,0.019,2,58531,0.0,0.31,true,false,\"['false', 'true']\",\"[40272, 18261]\"\n7,is_drink_order,boolean,True,1119,58533,0.019,2,58531,0.0,0.96,true,false,\"['true', 'false']\",\"[55974, 2559]\"\n8,order_cost,float64,True,1119,58533,0.019,1299,57234,0.022,2.52,24.33,0.63,\"['0.82000000000000006', '1.75', '1.54', '0.63', '4.25', '3.33', '3.21', '2.0300000000000002', '4.48', '2.3600000000000003', '2.5700000000000003', '1.4500000000000002', '1.6400000000000001', '1.8399999999999999', '3.93', '4.1400000000000006', '4.29', '4.97', '4.06', '2.75', '3.1399999999999997', '3.02', '5.2', '4.05', '5.41', '4.26', '5.18', '2.96', '2.38', '2.17']\",\"[14724, 7356, 7322, 7251, 754, 698, 664, 657, 656, 535, 508, 507, 490, 385, 369, 362, 360, 349, 338, 337, 335, 332, 329, 328, 326, 324, 319, 304, 276, 270]\"\n\n\n## Contents\n```sql\nwith \n--test\norders as (\n    \n    select * from {{ ref('stg_orders')}}\n\n),\n\norder_items_table as (\n    \n    select * from {{ ref('order_items')}}\n\n),\n\norder_items_summary as (\n\n    select\n\n        order_items.order_id,\n\n        sum(supply_cost) as order_cost,\n        sum(is_food_item) as count_food_items,\n        sum(is_drink_item) as count_drink_items\n\n\n    from order_items_table as order_items\n\n    group by 1\n\n),\n\n\ncompute_booleans as (\n    select\n\n        orders.*,\n        count_food_items > 0 as is_food_order,\n        count_drink_items > 0 as is_drink_order,\n        order_cost\n\n    from orders\n    \n    left join order_items_summary on orders.order_id = order_items_summary.order_id\n)\n\nselect * from compute_booleans\n\n```\n\n\n## order_items\n\n\n## Schema and profiling info\nposition,name,type,nullable,nulls,non_nulls,null_frac,n_distinct,duplicates,distinct_frac,avg,max,min,top_values,top_value_counts\n0,order_item_id,string,True,0,95368,0.0,95368,0,1.0,,fffff625-0990-4a07-b23d-55ebc35a35dc,000107ba-a444-4eac-86a9-732f84bd7401,\"['f618de9b-7f42-4515-9ab9-7de8c7b62498', 'f83ce338-80ab-4444-84eb-7ebcde5102b7', 'aed52e7f-0417-4b8a-9bc6-bd499e7cd4c8', 'c11830b7-ce22-4763-b61d-64bee766b872', 'ed99519e-a7b8-4d22-b4b5-7a7d71e2cd49', '644ba0ad-5498-49c4-91ab-7101e5580fc8', '64814d79-c81e-41c4-af5d-3cf186c40a0a', '51fe26dc-9ac1-4871-84ba-e62988431b69', 'fb3e3675-ba58-4b99-acfd-83488b14dbf9', 'c9dac2ea-1144-4518-9c3d-270d3c6f0dbd', '48f5efb3-9073-4741-b9c3-6cc5c768c9d2', 'a1ddabf7-9972-4745-92cc-b9e205079183', 'c2cd2119-5dea-4aaa-b8cf-23a2880a814a', '9305d5a0-84c5-4856-95aa-08eaa6ca511d', '30204a58-7a8e-48f2-b230-d6a575d5c1c1', '5719b6b7-a8bb-43cc-997d-93c114768463', '9d877f3f-db58-4b3a-908c-b3da5da77286', 'ecbdc09b-fe01-4d00-88b8-3405f7a22a47', '1ccf7b2f-fc32-4ccb-9a9e-b15460ad2990', '70746fc2-9a4f-4529-b36a-91b3832b23d9', '3d1cccb3-ba3a-4cfa-9600-7723193ffb7b', 'a8340d61-a05e-46f3-b9c0-816294a6d913', 'e0dcca9d-e3f5-45fa-944d-e2a56557edc0', '37c66317-d32b-4f66-bb34-56eb5bf603fa', '942124c4-e768-4a55-8d38-81f02b25f652', '31538c0a-b721-495a-a346-0a66e54b8f7e', 'f09b8b2a-525d-41a4-b0a6-30ca6d10b09a', '6b97b2a1-7e06-4905-8e47-b03c32294d6a', 'a5bf13b1-3c44-4ed6-b776-d9077401fdf5', '6f5a4072-e02d-4c20-bdf3-2e11f75bd8da']\",\"[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]\"\n1,order_id,string,True,0,95368,0.0,58533,36835,0.614,,fffe9fd6-17de-4a3a-a1a7-3a437c1c6a03,000165b9-8897-4779-86b3-bdc3f727ab9a,\"['87d78d54-2048-421d-9402-3e162e09e659', 'a728c5c1-3711-4323-83c8-cd7003897831', '10a80661-1e31-4772-85d2-724dd1cc74f2', 'd9f1b54f-a340-4d34-bd00-45cce061c0f3', '0fdf0eb1-61aa-4c57-9cc4-3f65fca685b0', '81ca7ac8-553f-4d98-bba3-0241127b32e7', 'cd10b427-5e2b-4fa0-90ad-1e14f18f31a4', '3217dbff-f186-4091-88d6-0393aac449fd', '63beaacd-c3f0-435e-86a5-7be6d9463a13', '41811343-9909-44bb-92e7-d112ac2aea08', '21024d8a-69fe-43b3-b338-533eeab27915', '1937a80f-dd8d-4cd0-9dce-d6d0066f01c4', 'ecf5e5a2-60ef-43d1-97ea-7b13fa6e500f', '140bb157-837a-4a4d-b31c-20efa9036382', '182716ee-7d62-410a-9de3-2776708b7d2c', '8517c969-e119-4557-a434-aaef1006f311', 'dd987570-51ab-42a1-87e8-5e1ea7084633', '3077ebda-b1e0-4058-a57d-e35693ae2d06', '0d863a61-818a-4ce7-a351-a1500a1f1321', 'b14314bf-f549-4084-b310-7132c0ef5c00', '6fd7ac6c-33b8-415d-a34c-ad1a297935a4', '733d5162-c92e-4d2d-8a4f-1360bf76ede6', '499cd7c2-425d-48c4-80fa-1d2d87ea2452', '0b7d6f0a-f85d-4960-b4c7-8a9613f06f68', '7c4ef30f-57ee-460b-b182-46662df64063', '03312ad3-dd0d-4db8-b29b-37885a8df14c', 'd902a65a-5120-4ddf-a310-2a4469c9dd81', '3a79c427-56d8-4303-acb8-dda15528dc9b', '5eb7d7d9-f066-4f88-b2dc-4e5de58a8621', '1aae3f59-8908-40dc-8da3-7e9c4ec930e3']\",\"[10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]\"\n2,product_id,string,True,0,95368,0.0,10,95358,0.0,,JAF-005,BEV-001,\"['BEV-001', 'BEV-003', 'BEV-005', 'BEV-002', 'BEV-004', 'JAF-005', 'JAF-001', 'JAF-004', 'JAF-002', 'JAF-003']\",\"[13794, 13624, 13609, 13576, 13509, 5548, 5485, 5416, 5404, 5403]\"\n3,product_price,float64,True,0,95368,0.0,7,95361,0.0,7.43,14,4,\"['6', '4', '5', '7', '12', '11', '14']\",\"[27418, 13609, 13576, 13509, 10951, 10889, 5416]\"\n4,supply_cost,float64,True,0,95368,0.0,9,95359,0.0,1.55,3.66,0.63,\"['0.82000000000000006', '1.54', '0.63', '1.75', '2.39', '1.21', '3.4299999999999997', '2.51', '3.66']\",\"[27303, 13624, 13609, 13576, 5548, 5485, 5416, 5404, 5403]\"\n5,is_food_item,int64,True,0,95368,0.0,2,95366,0.0,0.29,1,0,\"['0', '1']\",\"[68112, 27256]\"\n6,is_drink_item,int64,True,0,95368,0.0,2,95366,0.0,0.71,1,0,\"['1', '0']\",\"[68112, 27256]\"\n7,ordered_at,timestamp('UTC'),True,0,95368,0.0,365,95003,0.004,,2017-08-31 00:00:00+00,2016-09-01 00:00:00+00,\"['2017-08-28 00:00:00+00', '2017-06-12 00:00:00+00', '2017-08-29 00:00:00+00', '2017-08-25 00:00:00+00', '2017-06-15 00:00:00+00', '2017-06-08 00:00:00+00', '2017-08-14 00:00:00+00', '2017-06-14 00:00:00+00', '2017-08-31 00:00:00+00', '2017-08-30 00:00:00+00', '2017-08-22 00:00:00+00', '2017-08-24 00:00:00+00', '2017-06-05 00:00:00+00', '2017-06-16 00:00:00+00', '2017-08-15 00:00:00+00', '2017-08-23 00:00:00+00', '2017-06-09 00:00:00+00', '2017-06-06 00:00:00+00', '2017-08-07 00:00:00+00', '2017-05-26 00:00:00+00', '2017-08-17 00:00:00+00', '2017-06-02 00:00:00+00', '2017-06-07 00:00:00+00', '2017-05-31 00:00:00+00', '2017-06-19 00:00:00+00', '2017-08-08 00:00:00+00', '2017-07-21 00:00:00+00', '2017-08-10 00:00:00+00', '2017-08-16 00:00:00+00', '2017-05-22 00:00:00+00']\",\"[566, 556, 547, 546, 545, 544, 541, 541, 537, 533, 528, 524, 521, 513, 512, 511, 511, 509, 508, 508, 506, 503, 503, 503, 503, 501, 498, 498, 495, 492]\"\n\n\n## Contents\n```sql\nwith \n\norder_items as (\n\n    select * from {{ ref('stg_order_items') }}\n\n),\n\n\norders as (\n    \n    select * from {{ ref('stg_orders')}}\n),\n\nproducts as (\n\n    select * from {{ ref('stg_products') }}\n\n),\n\nsupplies as (\n\n  select * from {{ ref('stg_supplies') }}\n\n),\n\norder_supplies_summary as (\n\n  select\n    product_id,\n    sum(supply_cost) as supply_cost\n\n  from supplies\n\n  group by 1\n),\n\njoined as (\n    select\n        order_items.*,\n        products.product_price,\n        order_supplies_summary.supply_cost,\n        products.is_food_item,\n        products.is_drink_item,\n        orders.ordered_at\n\n    from order_items\n\n    left join orders on order_items.order_id  = orders.order_id\n    \n    left join products on order_items.product_id = products.product_id\n    \n    left join order_supplies_summary on order_items.product_id = order_supplies_summary.product_id\n    \n)\n\nselect * from joined\n--test\n```\n\nUser Instructions: explain\n\nContext Files:\n```sql\nwith\n\ncustomers as (\n\n    select * from {{ ref('stg_customers') }}\n\n),\n\norders_table as (\n\n    select * from {{ ref('orders') }}\n\n),\n\norder_items_table as (\n\n    select * from {{ ref('order_items') }}\n),\n\norder_summary as (\n\n    select\n        customer_id,\n\n        count(distinct orders.order_id) as count_lifetime_orders,\n        count(distinct orders.order_id) > 1 as is_repeat_buyer,\n        min(orders.ordered_at) as first_ordered_at,\n        max(orders.ordered_at) as last_ordered_at,\n        sum(order_items.product_price) as lifetime_spend_pretax,\n        sum(orders.order_total) as lifetime_spend\n\n    from orders_table as orders\n    \n    left join order_items_table as order_items on orders.order_id = order_items.order_id\n    \n    group by 1\n\n),\n\njoined as (\n\n    select\n        customers.*,\n        order_summary.count_lifetime_orders,\n        order_summary.first_ordered_at,\n        order_summary.last_ordered_at,\n        order_summary.lifetime_spend_pretax,\n        order_summary.lifetime_spend,\n\n        case\n            when order_summary.is_repeat_buyer then 'returning'\n            else 'new'\n        end as customer_type\n\n    from customers\n\n    left join order_summary\n        on customers.customer_id = order_summary.customer_id\n\n)\n\nselect * from joined\n\n```\n"
  }
]